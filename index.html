<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instruksi Kerja Pemasangan Perangkat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/piexifjs/1.0.6/piexif.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .school-input {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .school-input label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .school-input input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .instruction-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-left: 4px solid #3498db;
        }
        
        .section-title {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .section-number {
            background-color: #3498db;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }
        
        .requirements {
            margin-left: 20px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .requirements li {
            margin-bottom: 5px;
        }
        
        .upload-area {
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin-top: 15px;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            background-color: #e8f4fc;
        }
        
        .upload-icon {
            font-size: 30px;
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .upload-text {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .upload-hint {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .hidden {
            display: none;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }
        
        .btn-submit {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-submit:hover {
            background-color: #27ae60;
        }
        
        .btn-reset {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-reset:hover {
            background-color: #c0392b;
        }
        
        .btn-download {
            background-color: #9b59b6;
            color: white;
        }
        
        .btn-download:hover {
            background-color: #8e44ad;
        }
        
        .btn-location {
            background-color: #f39c12;
            color: white;
            padding: 8px 15px;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .btn-location:hover {
            background-color: #e67e22;
        }
        
        .status-message {
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .folder-info {
            background-color: #e8f4fc;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #3498db;
        }
        
        .location-info {
            background-color: #fff3cd;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            border-left: 3px solid #ffc107;
        }
        
        .location-input {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            border: 1px dashed #ccc;
        }
        
        .location-input input {
            width: calc(50% - 10px);
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #7f8c8d;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .instruction-section {
                padding: 15px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            button {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .location-input input {
                width: calc(100% - 10px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Instruksi Kerja Pemasangan Perangkat</h1>
            <p class="subtitle">Ambil foto sesuai instruksi - Input lokasi manual jika perlu</p>
        </header>
        
        <form id="installationForm">
            <!-- Input Nama Sekolah -->
            <div class="school-input">
                <label for="schoolName">Nama Sekolah:</label>
                <input type="text" id="schoolName" placeholder="Masukkan nama sekolah lengkap" required>
            </div>
            
            <!-- Langkah 1 -->
            <div class="instruction-section">
                <div class="section-title">
                    <div class="section-number">1</div>
                    <h2>Foto Plang Sekolah</h2>
                </div>
                <p>Ambil foto plang sekolah yang jelas dan dapat terbaca dengan baik.</p>
                
                <div class="upload-area" onclick="triggerUpload('photo1')">
                    <div class="upload-icon">üì∑</div>
                    <div class="upload-text">Klik untuk Mengambil Foto</div>
                    <div class="upload-hint">Lokasi akan diminta setelah foto diambil</div>
                </div>
                <input type="file" id="photo1" class="hidden" accept="image/*" capture="environment" onchange="processPhoto(this, 1)">
                <img id="preview1" class="preview-image hidden">
                <div id="locationInput1" class="location-input hidden">
                    <p><strong>üìç Input Koordinat Lokasi:</strong></p>
                    <input type="text" id="lat1" placeholder="Latitude (contoh: -6.2088)">
                    <input type="text" id="lng1" placeholder="Longitude (contoh: 106.8456)">
                    <button type="button" class="btn-location" onclick="saveManualLocation(1)">Simpan Lokasi</button>
                </div>
                <div id="locationInfo1" class="location-info hidden"></div>
            </div>
            
            <!-- Langkah 2 -->
            <div class="instruction-section">
                <div class="section-title">
                    <div class="section-number">2</div>
                    <h2>Foto PIC dengan Dus</h2>
                </div>
                <p>Ambil foto PIC (Person In Charge) bersama dengan dus perangkat.</p>
                
                <div class="upload-area" onclick="triggerUpload('photo2')">
                    <div class="upload-icon">üì∑</div>
                    <div class="upload-text">Klik untuk Mengambil Foto</div>
                    <div class="upload-hint">Lokasi akan diminta setelah foto diambil</div>
                </div>
                <input type="file" id="photo2" class="hidden" accept="image/*" capture="environment" onchange="processPhoto(this, 2)">
                <img id="preview2" class="preview-image hidden">
                <div id="locationInput2" class="location-input hidden">
                    <p><strong>üìç Input Koordinat Lokasi:</strong></p>
                    <input type="text" id="lat2" placeholder="Latitude (contoh: -6.2088)">
                    <input type="text" id="lng2" placeholder="Longitude (contoh: 106.8456)">
                    <button type="button" class="btn-location" onclick="saveManualLocation(2)">Simpan Lokasi</button>
                </div>
                <div id="locationInfo2" class="location-info hidden"></div>
            </div>
            
            <!-- Langkah 3 -->
            <div class="instruction-section">
                <div class="section-title">
                    <div class="section-number">3</div>
                    <h2>Foto Kelengkapan Perangkat</h2>
                </div>
                <p>Ambil foto semua kelengkapan perangkat yang akan dipasang.</p>
                <div class="requirements">
                    <p><strong>Harus menunjukkan:</strong></p>
                    <ul>
                        <li>3 kabel + 1 Remote + Baterai</li>
                        <li>2 Pen + 1 Buku panduan + 1 Buku garansi</li>
                    </ul>
                </div>
                
                <div class="upload-area" onclick="triggerUpload('photo3')">
                    <div class="upload-icon">üì∑</div>
                    <div class="upload-text">Klik untuk Mengambil Foto</div>
                    <div class="upload-hint">Lokasi akan diminta setelah foto diambil</div>
                </div>
                <input type="file" id="photo3" class="hidden" accept="image/*" capture="environment" onchange="processPhoto(this, 3)">
                <img id="preview3" class="preview-image hidden">
                <div id="locationInput3" class="location-input hidden">
                    <p><strong>üìç Input Koordinat Lokasi:</strong></p>
                    <input type="text" id="lat3" placeholder="Latitude (contoh: -6.2088)">
                    <input type="text" id="lng3" placeholder="Longitude (contoh: 106.8456)">
                    <button type="button" class="btn-location" onclick="saveManualLocation(3)">Simpan Lokasi</button>
                </div>
                <div id="locationInfo3" class="location-info hidden"></div>
            </div>
            
            <!-- Langkah 4 -->
            <div class="instruction-section">
                <div class="section-title">
                    <div class="section-number">4</div>
                    <h2>Foto Proses Instalasi</h2>
                </div>
                <p>Dokumentasikan proses instalasi atau pemasangan perangkat.</p>
                
                <div class="upload-area" onclick="triggerUpload('photo4')">
                    <div class="upload-icon">üì∑</div>
                    <div class="upload-text">Klik untuk Mengambil Foto</div>
                    <div class="upload-hint">Lokasi akan diminta setelah foto diambil</div>
                </div>
                <input type="file" id="photo4" class="hidden" accept="image/*" capture="environment" onchange="processPhoto(this, 4)">
                <img id="preview4" class="preview-image hidden">
                <div id="locationInput4" class="location-input hidden">
                    <p><strong>üìç Input Koordinat Lokasi:</strong></p>
                    <input type="text" id="lat4" placeholder="Latitude (contoh: -6.2088)">
                    <input type="text" id="lng4" placeholder="Longitude (contoh: 106.8456)">
                    <button type="button" class="btn-location" onclick="saveManualLocation(4)">Simpan Lokasi</button>
                </div>
                <div id="locationInfo4" class="location-info hidden"></div>
            </div>
            
            <!-- Langkah 5 -->
            <div class="instruction-section">
                <div class="section-title">
                    <div class="section-number">5</div>
                    <h2>Foto IMEI / SN (Serial Number)</h2>
                </div>
                <p>Ambil foto IMEI atau Serial Number yang terletak di belakang TV.</p>
                
                <div class="upload-area" onclick="triggerUpload('photo5')">
                    <div class="upload-icon">üì∑</div>
                    <div class="upload-text">Klik untuk Mengambil Foto</div>
                    <div class="upload-hint">Lokasi akan diminta setelah foto diambil</div>
                </div>
                <input type="file" id="photo5" class="hidden" accept="image/*" capture="environment" onchange="processPhoto(this, 5)">
                <img id="preview5" class="preview-image hidden">
                <div id="locationInput5" class="location-input hidden">
                    <p><strong>üìç Input Koordinat Lokasi:</strong></p>
                    <input type="text" id="lat5" placeholder="Latitude (contoh: -6.2088)">
                    <input type="text" id="lng5" placeholder="Longitude (contoh: 106.8456)">
                    <button type="button" class="btn-location" onclick="saveManualLocation(5)">Simpan Lokasi</button>
                </div>
                <div id="locationInfo5" class="location-info hidden"></div>
            </div>
            
            <!-- Langkah 6 -->
            <div class="instruction-section">
                <div class="section-title">
                    <div class="section-number">6</div>
                    <h2>Foto Training</h2>
                </div>
                <p>Ambil foto sesi training yang sedang berlangsung.</p>
                <div class="requirements">
                    <p><strong>Wajib menunjukkan:</strong></p>
                    <ul>
                        <li>Teach Buddy terinstal</li>
                        <li>Terlihat di semua direktorat</li>
                    </ul>
                </div>
                
                <div class="upload-area" onclick="triggerUpload('photo6')">
                    <div class="upload-icon">üì∑</div>
                    <div class="upload-text">Klik untuk Mengambil Foto</div>
                    <div class="upload-hint">Lokasi akan diminta setelah foto diambil</div>
                </div>
                <input type="file" id="photo6" class="hidden" accept="image/*" capture="environment" onchange="processPhoto(this, 6)">
                <img id="preview6" class="preview-image hidden">
                <div id="locationInput6" class="location-input hidden">
                    <p><strong>üìç Input Koordinat Lokasi:</strong></p>
                    <input type="text" id="lat6" placeholder="Latitude (contoh: -6.2088)">
                    <input type="text" id="lng6" placeholder="Longitude (contoh: 106.8456)">
                    <button type="button" class="btn-location" onclick="saveManualLocation(6)">Simpan Lokasi</button>
                </div>
                <div id="locationInfo6" class="location-info hidden"></div>
            </div>
            
            <!-- Langkah 7 -->
            <div class="instruction-section">
                <div class="section-title">
                    <div class="section-number">7</div>
                    <h2>Foto BAPP Halaman 1</h2>
                </div>
                <p>Ambil foto Berita Acara Pemeriksaan dan Penerimaan (BAPP) halaman 1.</p>
                <div class="requirements">
                    <ul>
                        <li>IMEI barcode ditempel</li>
                        <li>Di conteng yang sesuai</li>
                        <li>Bagian atas diisi semua</li>
                        <li>Stempel dan tanda tangan</li>
                    </ul>
                </div>
                
                <div class="upload-area" onclick="triggerUpload('photo7')">
                    <div class="upload-icon">üì∑</div>
                    <div class="upload-text">Klik untuk Mengambil Foto</div>
                    <div class="upload-hint">TANPA GeoTagging</div>
                </div>
                <input type="file" id="photo7" class="hidden" accept="image/*" capture="environment" onchange="processPhoto(this, 7, false)">
                <img id="preview7" class="preview-image hidden">
            </div>
            
            <!-- Langkah 8 -->
            <div class="instruction-section">
                <div class="section-title">
                    <div class="section-number">8</div>
                    <h2>Foto BAPP Halaman 2</h2>
                </div>
                <p>Ambil foto Berita Acara Pemeriksaan dan Penerimaan (BAPP) halaman 2.</p>
                <div class="requirements">
                    <ul>
                        <li>Nama pelatihan diisi</li>
                        <li>Media pelatihan diconteng di luar jaringan</li>
                        <li>Coret "belum dapat diterima" dan "belum berada"</li>
                        <li>Stempel dan tanda tangan</li>
                    </ul>
                </div>
                
                <div class="upload-area" onclick="triggerUpload('photo8')">
                    <div class="upload-icon">üì∑</div>
                    <div class="upload-text">Klik untuk Mengambil Foto</div>
                    <div class="upload-hint">TANPA GeoTagging</div>
                </div>
                <input type="file" id="photo8" class="hidden" accept="image/*" capture="environment" onchange="processPhoto(this, 8, false)">
                <img id="preview8" class="preview-image hidden">
            </div>
            
            <div class="action-buttons">
                <button type="button" class="btn-reset" onclick="resetForm()">Reset Semua</button>
                <button type="button" class="btn-download" onclick="downloadAllPhotos()">Download Semua Foto (ZIP)</button>
            </div>
            
            <div id="statusMessage" class="status-message hidden"></div>
            <div id="folderInfo" class="folder-info hidden"></div>
        </form>
        
        <footer>
            <p>¬© 2023 - Instruksi Kerja Pemasangan Perangkat</p>
        </footer>
    </div>

    <script>
        // Data untuk menyimpan foto dengan geotagging
        let photoData = {
            schoolName: '',
            photos: {}
        };

        // Nama file untuk setiap langkah
        const photoNames = {
            1: "1_plang_sekolah.jpg",
            2: "2_pic_dengan_dus.jpg", 
            3: "3_kelengkapan_perangkat.jpg",
            4: "4_proses_instalasi.jpg",
            5: "5_imei_sn.jpg",
            6: "6_training.jpg",
            7: "7_bapp_halaman1.jpg",
            8: "8_bapp_halaman2.jpg"
        };

        // Fungsi untuk memicu upload file
        function triggerUpload(inputId) {
            document.getElementById(inputId).click();
        }
        
        // Fungsi untuk memproses foto dan menambahkan geotagging
        function processPhoto(input, stepNumber, includeGeotagging = true) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                // Tampilkan preview
                const preview = document.getElementById('preview' + stepNumber);
                preview.src = e.target.result;
                preview.classList.remove('hidden');

                if (includeGeotagging) {
                    // Simpan foto sementara tanpa geotagging
                    photoData.photos[stepNumber] = {
                        dataUrl: e.target.result,
                        location: null,
                        fileName: photoNames[stepNumber],
                        needsGeotagging: true
                    };

                    // Tampilkan input lokasi manual
                    showManualLocationInput(stepNumber);
                    
                    // Coba dapatkan lokasi otomatis
                    getLocation().then(location => {
                        // Otomatis isi form dengan lokasi yang didapat
                        document.getElementById('lat' + stepNumber).value = location.lat.toFixed(6);
                        document.getElementById('lng' + stepNumber).value = location.lng.toFixed(6);
                        
                        showStatus('Lokasi otomatis berhasil didapatkan! Silakan simpan.', 'success');
                    }).catch(error => {
                        if (error === 'User denied Geolocation') {
                            showStatus('Akses lokasi ditolak. Silakan input koordinat manual.', 'warning');
                        } else {
                            showStatus('Tidak dapat mendapatkan lokasi. Silakan input manual.', 'warning');
                        }
                    });
                } else {
                    // Simpan foto tanpa geotagging (untuk BAPP)
                    photoData.photos[stepNumber] = {
                        dataUrl: e.target.result,
                        location: null,
                        fileName: photoNames[stepNumber],
                        needsGeotagging: false
                    };
                    showStatus('Foto BAPP berhasil disimpan (tanpa geotagging)', 'success');
                }
            };
            
            reader.readAsDataURL(file);
        }

        // Fungsi untuk menampilkan input lokasi manual
        function showManualLocationInput(stepNumber) {
            const locationInput = document.getElementById('locationInput' + stepNumber);
            locationInput.classList.remove('hidden');
        }

        // Fungsi untuk menyimpan lokasi manual
        function saveManualLocation(stepNumber) {
            const latInput = document.getElementById('lat' + stepNumber);
            const lngInput = document.getElementById('lng' + stepNumber);
            
            const lat = parseFloat(latInput.value);
            const lng = parseFloat(lngInput.value);
            
            if (isNaN(lat) || isNaN(lng)) {
                showStatus('Harap masukkan koordinat yang valid!', 'error');
                return;
            }

            const location = {
                lat: lat,
                lng: lng,
                timestamp: new Date().toISOString(),
                source: 'manual'
            };

            // Tambahkan geotagging ke foto
            addGeotaggingToPhoto(photoData.photos[stepNumber].dataUrl, location, stepNumber);
            
            // Sembunyikan input lokasi
            document.getElementById('locationInput' + stepNumber).classList.add('hidden');
        }

        // Fungsi untuk mendapatkan lokasi
        function getLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject('Browser tidak mendukung geolocation');
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    position => {
                        const location = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            timestamp: new Date().toISOString(),
                            source: 'gps'
                        };
                        resolve(location);
                    },
                    error => {
                        if (error.code === error.PERMISSION_DENIED) {
                            reject('User denied Geolocation');
                        } else {
                            reject('Tidak dapat mengakses lokasi: ' + error.message);
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0
                    }
                );
            });
        }

        // Fungsi untuk menambahkan geotagging ke foto
        function addGeotaggingToPhoto(dataUrl, location, stepNumber) {
            try {
                // Buat objek EXIF data dengan geotagging
                const exifObj = {
                    "0th": {},
                    "Exif": {},
                    "GPS": {
                        [piexif.GPSIFD.GPSLatitudeRef]: location.lat >= 0 ? "N" : "S",
                        [piexif.GPSIFD.GPSLatitude]: piexif.GPSHelper.degToDms(Math.abs(location.lat)),
                        [piexif.GPSIFD.GPSLongitudeRef]: location.lng >= 0 ? "E" : "W", 
                        [piexif.GPSIFD.GPSLongitude]: piexif.GPSHelper.degToDms(Math.abs(location.lng)),
                        [piexif.GPSIFD.GPSMapDatum]: "WGS-84"
                    },
                    "Interop": {},
                    "1st": {},
                    "thumbnail": null
                };

                // Tambahkan timestamp
                const date = new Date(location.timestamp);
                const dateStr = date.toISOString().split('T')[0].replace(/-/g, ':');
                const timeStr = date.toTimeString().split(' ')[0];
                
                exifObj["Exif"][piexif.ExifIFD.DateTimeOriginal] = dateStr + ' ' + timeStr;
                exifObj["Exif"][piexif.ExifIFD.DateTimeDigitized] = dateStr + ' ' + timeStr;

                // Insert EXIF data ke foto
                const exifStr = piexif.dump(exifObj);
                const newDataUrl = piexif.insert(exifStr, dataUrl);

                // Update foto dengan geotagging
                photoData.photos[stepNumber].dataUrl = newDataUrl;
                photoData.photos[stepNumber].location = location;
                photoData.photos[stepNumber].needsGeotagging = false;

                // Tampilkan info lokasi
                const locationInfo = document.getElementById('locationInfo' + stepNumber);
                locationInfo.innerHTML = `
                    <strong>üìç Lokasi tersimpan (${location.source === 'gps' ? 'GPS' : 'Manual'}):</strong><br>
                    Lat: ${location.lat.toFixed(6)} | Lng: ${location.lng.toFixed(6)}<br>
                    Waktu: ${date.toLocaleString('id-ID')}
                `;
                locationInfo.classList.remove('hidden');

                showStatus(`Lokasi berhasil disimpan untuk foto ${stepNumber}!`, 'success');

            } catch (error) {
                console.error('Error adding geotagging:', error);
                showStatus('Error menambahkan geotagging ke foto', 'error');
            }
        }

        // Fungsi untuk reset form
        function resetForm() {
            if (confirm('Apakah Anda yakin ingin mereset semua data?')) {
                document.getElementById('installationForm').reset();
                document.getElementById('schoolName').value = '';
                
                // Sembunyikan semua preview dan info lokasi
                for (let i = 1; i <= 8; i++) {
                    document.getElementById('preview' + i).classList.add('hidden');
                    const locationInfo = document.getElementById('locationInfo' + i);
                    if (locationInfo) locationInfo.classList.add('hidden');
                    const locationInput = document.getElementById('locationInput' + i);
                    if (locationInput) locationInput.classList.add('hidden');
                }
                
                // Sembunyikan pesan status
                document.getElementById('statusMessage').classList.add('hidden');
                document.getElementById('folderInfo').classList.add('hidden');
                
                // Reset data
                photoData = {
                    schoolName: '',
                    photos: {}
                };
            }
        }

        // Fungsi untuk mendownload semua foto sebagai ZIP
        async function downloadAllPhotos() {
            const schoolName = document.getElementById('schoolName').value.trim();
            if (!schoolName) {
                showStatus('Harap masukkan nama sekolah terlebih dahulu!', 'error');
                document.getElementById('schoolName').focus();
                return;
            }

            // Cek apakah semua foto sudah ada
            const missingPhotos = [];
            for (let i = 1; i <= 8; i++) {
                if (!photoData.photos[i]) {
                    missingPhotos.push(i);
                }
            }

            if (missingPhotos.length > 0) {
                showStatus(`Harap lengkapi foto untuk langkah: ${missingPhotos.join(', ')}`, 'error');
                return;
            }

            // Cek apakah foto 1-6 sudah punya geotagging
            const missingGeotagging = [];
            for (let i = 1; i <= 6; i++) {
                if (photoData.photos[i].needsGeotagging) {
                    missingGeotagging.push(i);
                }
            }

            if (missingGeotagging.length > 0) {
                showStatus(`Harap tambahkan lokasi untuk foto: ${missingGeotagging.join(', ')}`, 'warning');
                return;
            }

            photoData.schoolName = schoolName;
            const folderName = schoolName.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_');

            try {
                const zip = new JSZip();
                const folder = zip.folder(folderName);

                // Tambahkan setiap foto ke ZIP
                for (const [step, data] of Object.entries(photoData.photos)) {
                    // Konversi data URL ke blob
                    const response = await fetch(data.dataUrl);
                    const blob = await response.blob();
                    
                    // Tambahkan ke ZIP dengan nama yang sesuai
                    folder.file(data.fileName, blob);
                }

                // Buat file info dengan detail lokasi
                let locationInfo = 'LOKASI GEOGRAFIS:\n';
                for (let i = 1; i <= 6; i++) {
                    if (photoData.photos[i] && photoData.photos[i].location) {
                        const loc = photoData.photos[i].location;
                        locationInfo += `\n${photoNames[i]}:\n`;
                        locationInfo += `  Latitude: ${loc.lat.toFixed(6)}\n`;
                        locationInfo += `  Longitude: ${loc.lng.toFixed(6)}\n`;
                        locationInfo += `  Sumber: ${loc.source}\n`;
                        locationInfo += `  Waktu: ${new Date(loc.timestamp).toLocaleString('id-ID')}\n`;
                    }
                }

                const infoContent = `
LAPORAN INSTALASI PERANGKAT
============================

Nama Sekolah: ${schoolName}
Tanggal: ${new Date().toLocaleDateString('id-ID')}
Total Foto: ${Object.keys(photoData.photos).length}

${locationInfo}

Daftar File:
${Object.values(photoNames).join('\n')}

Keterangan:
- Foto 1-6 mengandung metadata GPS
- Foto 7-8 adalah dokumentasi BAPP (tanpa GPS)
                `;
                
                folder.file('INFO.txt', infoContent);

                // Generate dan download ZIP
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const zipFileName = `${folderName}_instalasi.zip`;
                
                saveAs(zipBlob, zipFileName);
                
                showStatus(`File ZIP "${zipFileName}" berhasil didownload!`, 'success');
                
                // Tampilkan info folder
                document.getElementById('folderInfo').innerHTML = `
                    <h3>üìÅ File Berhasil Dibuat:</h3>
                    <p><strong>Nama File:</strong> ${zipFileName}</p>
                    <p><strong>Folder:</strong> ${folderName}/</p>
                    <div style="margin-top: 10px; font-family: monospace; font-size: 12px; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                        ${Object.values(photoNames).map(name => `üì∑ ${name}`).join('<br>')}
                    </div>
                    <p style="margin-top: 10px; font-size: 12px; color: #666;">
                        ‚úÖ Semua foto 1-6 sudah mengandung metadata GPS<br>
                        üìÑ Foto 7-8 adalah dokumentasi BAPP<br>
                        üìç Lokasi tersimpan dalam file INFO.txt
                    </p>
                `;
                document.getElementById('folderInfo').classList.remove('hidden');
                
            } catch (error) {
                showStatus('Error membuat file ZIP: ' + error.message, 'error');
            }
        }

        // Fungsi untuk menampilkan status
        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message ${type}`;
            statusElement.classList.remove('hidden');
            
            // Scroll ke status message
            statusElement.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
